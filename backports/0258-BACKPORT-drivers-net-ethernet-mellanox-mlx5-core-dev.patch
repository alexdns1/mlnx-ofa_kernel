From: Mohammad Kabat <mohammadkab@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/net/ethernet/mellanox/mlx5/core/dev.c

Change-Id: I17249f399d0baf4a33b3830e941ce798c209b460
---
 drivers/net/ethernet/mellanox/mlx5/core/dev.c | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

--- a/drivers/net/ethernet/mellanox/mlx5/core/dev.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/dev.c
@@ -195,12 +195,20 @@ static const struct mlx5_adev_device {
 
 int mlx5_adev_idx_alloc(void)
 {
+#ifdef HAVE_IDA_ALLOC
 	return ida_alloc(&mlx5_adev_ida, GFP_KERNEL);
+#else
+	return ida_simple_get(&mlx5_adev_ida,0, 0, GFP_KERNEL);
+#endif
 }
 
 void mlx5_adev_idx_free(int idx)
 {
+#ifdef HAVE_IDA_FREE
 	ida_free(&mlx5_adev_ida, idx);
+#else
+	ida_simple_remove(&mlx5_adev_ida, idx);
+#endif
 }
 
 int mlx5_adev_init(struct mlx5_core_dev *dev)
@@ -482,7 +490,11 @@ static struct mlx5_core_dev *is_mlx5_cor
 	return (struct mlx5_core_dev *)pci_get_drvdata(pdev);
 }
 
+#ifdef HAVE_BUS_FIND_DEVICE_GET_CONST
 static int next_phys_dev(struct device *dev, const void *data)
+#else
+static int next_phys_dev(struct device *dev, void *data)
+#endif
 {
 	const struct mlx5_core_dev *curr = data;
 
@@ -504,8 +516,13 @@ static int next_phys_dev(struct device *
 	return 1;
 }
 
+#ifdef HAVE_BUS_FIND_DEVICE_GET_CONST
 static struct device *pci_find_dev(void *data,
 				   int (*match)(struct device *dev, const void *data))
+#else
+static struct device *pci_find_dev(void *data,
+				   int (*match)(struct device *dev, void *data))
+#endif
 {
 	return bus_find_device(&pci_bus_type, NULL, data, match);
 }
