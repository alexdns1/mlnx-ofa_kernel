From: Raed Salem <raeds@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/en_accel/macsec.c

---
 .../mellanox/mlx5/core/en_accel/macsec.c      | 35 +++++++++++++------
 1 file changed, 24 insertions(+), 11 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/en_accel/macsec.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en_accel/macsec.c
@@ -617,9 +617,10 @@ static int mlx5e_macsec_add_txsa(struct
 	struct mlx5e_macsec *macsec;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 
 	macsec = priv->macsec;
@@ -694,9 +695,10 @@ static int mlx5e_macsec_upd_txsa(struct
 	struct net_device *netdev;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 
 	macsec = priv->macsec;
@@ -756,9 +758,10 @@ static int mlx5e_macsec_del_txsa(struct
 	struct mlx5e_macsec *macsec;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 	macsec = priv->macsec;
 	macsec_device = mlx5e_macsec_get_macsec_device_context(macsec, ctx->secy->netdev);
@@ -810,9 +813,10 @@ static int mlx5e_macsec_add_rxsc(struct
 	struct mlx5e_macsec *macsec;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 	macsec = priv->macsec;
 	macsec_device = mlx5e_macsec_get_macsec_device_context(macsec, ctx->secy->netdev);
@@ -883,9 +887,10 @@ static int mlx5e_macsec_upd_rxsc(struct
 	int i;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 
 	macsec = priv->macsec;
@@ -959,8 +964,10 @@ static int mlx5e_macsec_del_rxsc(struct
 	struct list_head *list;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
+#endif
 
 	mutex_lock(&priv->macsec->lock);
 
@@ -1003,9 +1010,10 @@ static int mlx5e_macsec_add_rxsa(struct
 	struct list_head *list;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 
 	macsec = priv->macsec;
@@ -1091,9 +1099,10 @@ static int mlx5e_macsec_upd_rxsa(struct
 	struct list_head *list;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 
 	macsec = priv->macsec;
@@ -1150,9 +1159,10 @@ static int mlx5e_macsec_del_rxsa(struct
 	struct list_head *list;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 
 	macsec = priv->macsec;
@@ -1202,9 +1212,10 @@ static int mlx5e_macsec_add_secy(struct
 	struct mlx5e_macsec *macsec;
 	int err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	if (!mlx5e_macsec_secy_features_validate(ctx))
 		return -EINVAL;
 
@@ -1313,9 +1324,10 @@ static int mlx5e_macsec_upd_secy(struct
 	struct mlx5e_macsec *macsec;
 	int i, err = 0;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	if (!mlx5e_macsec_secy_features_validate(ctx))
 		return -EINVAL;
 
@@ -1380,9 +1392,10 @@ static int mlx5e_macsec_del_secy(struct
 	int err = 0;
 	int i;
 
+#ifdef HAVE_MACSEC_CTX_PREPARE
 	if (ctx->prepare)
 		return 0;
-
+#endif
 	mutex_lock(&priv->macsec->lock);
 	macsec = priv->macsec;
 	macsec_device = mlx5e_macsec_get_macsec_device_context(macsec, ctx->secy->netdev);
