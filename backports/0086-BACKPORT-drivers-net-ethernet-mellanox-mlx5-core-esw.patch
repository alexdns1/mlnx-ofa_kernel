From: Talat Batheesh <talatb@mellanox.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/eswitch_devlink_compat.c

Change-Id: I2533f0e24095ab75e59fb3fc4509f792babeca21
---
 .../mellanox/mlx5/core/eswitch_devlink_compat.c    | 55 ++++++++++++++++++++--
 1 file changed, 51 insertions(+), 4 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/eswitch_devlink_compat.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/eswitch_devlink_compat.c
@@ -4,6 +4,7 @@
 #include <linux/mlx5/mlx5_ifc.h>
 #include <linux/mlx5/vport.h>
 #include <linux/mlx5/fs.h>
+#include <uapi/linux/devlink.h>
 #include <linux/fs.h>
 #include "mlx5_core.h"
 #include "eswitch.h"
@@ -28,9 +29,22 @@ static char *encap_to_str[] = {
 	[DEVLINK_ESWITCH_ENCAP_MODE_BASIC] = "basic",
 };
 
+static char *uplink_rep_mode_to_str[] = {
+	[MLX5_ESW_UPLINK_REP_MODE_NEW_NETDEV] = "new_netdev",
+	[MLX5_ESW_UPLINK_REP_MODE_NIC_NETDEV] = "nic_netdev",
+};
+
 struct devlink_compat_op {
+#ifdef HAVE_DEVLINK_ESWITCH_MODE_SET_EXTACK
+	int (*write_enum)(struct devlink *devlink, enum devlink_eswitch_encap_mode set, struct netlink_ext_ack *extack);
 	int (*write_u8)(struct devlink *devlink, u8 set, struct netlink_ext_ack *extack);
 	int (*write_u16)(struct devlink *devlink, u16 set, struct netlink_ext_ack *extack);
+#else
+	int (*write_enum)(struct devlink *devlink, enum devlink_eswitch_encap_mode set);
+	int (*write_u8)(struct devlink *devlink, u8 set);
+	int (*write_u16)(struct devlink *devlink, u16 set);
+#endif
+	int (*read_enum)(struct devlink *devlink, enum devlink_eswitch_encap_mode *read);
 	int (*read_u8)(struct devlink *devlink, u8 *read);
 	int (*read_u16)(struct devlink *devlink, u16 *read);
 	char **map;
@@ -54,12 +68,24 @@ static struct devlink_compat_op devlink_
 		.compat_name = "inline",
 	},
 	{
+#ifdef HAVE_DEVLINK_HAS_ESWITCH_ENCAP_MODE_SET_GET_WITH_ENUM
+		.read_enum = mlx5_devlink_eswitch_encap_mode_get,
+		.write_enum = mlx5_devlink_eswitch_encap_mode_set,
+#else
 		.read_u8 = mlx5_devlink_eswitch_encap_mode_get,
 		.write_u8 = mlx5_devlink_eswitch_encap_mode_set,
+#endif
 		.map = encap_to_str,
 		.map_size = ARRAY_SIZE(encap_to_str),
 		.compat_name = "encap",
 	},
+	{
+		.read_u8 = mlx5_devlink_eswitch_uplink_rep_mode_get,
+		.write_u8 = mlx5_devlink_eswitch_uplink_rep_mode_set,
+		.map = uplink_rep_mode_to_str,
+		.map_size = ARRAY_SIZE(uplink_rep_mode_to_str),
+		.compat_name = "uplink_rep_mode",
+	},
 };
 
 struct compat_devlink {
@@ -79,6 +105,7 @@ static ssize_t esw_compat_read(struct ko
 	const char *entname = attr->attr.name;
 	struct devlink_compat_op *op = 0;
 	int i = 0, ret, len = 0;
+	enum devlink_eswitch_encap_mode read_enum;
 	u8 read8;
 	u16 read;
 
@@ -92,9 +119,12 @@ static ssize_t esw_compat_read(struct ko
 
 	if (op->read_u16) {
 		ret = op->read_u16(devlink, &read);
-	} else {
+	} else if (op->read_u8) {
 		ret = op->read_u8(devlink, &read8);
 		read = read8;
+	} else {
+		ret = op->read_enum(devlink, &read_enum);
+		read = read_enum;
 	}
 
 	if (ret < 0)
@@ -117,7 +147,9 @@ static ssize_t esw_compat_write(struct k
 						       devlink_kobj);
 	struct mlx5_core_dev *dev = cdevlink->mdev;
 	struct devlink *devlink = priv_to_devlink(dev);
+#ifdef HAVE_NETLINK_EXT_ACK
 	static struct netlink_ext_ack ack = { ._msg = NULL };
+#endif
 	const char *entname = attr->attr.name;
 	struct devlink_compat_op *op = 0;
 	u16 set = 0;
@@ -147,13 +179,28 @@ static ssize_t esw_compat_write(struct k
 	}
 
 	if (op->write_u16)
-		ret = op->write_u16(devlink, set, &ack);
+		ret = op->write_u16(devlink, set
+#ifdef HAVE_DEVLINK_ESWITCH_MODE_SET_EXTACK
+				    , &ack
+#endif
+				    );
+	else if (op->write_u8)
+		ret = op->write_u8(devlink, set
+#ifdef HAVE_DEVLINK_ESWITCH_MODE_SET_EXTACK
+				   , &ack
+#endif
+				   );
 	else
-		ret = op->write_u8(devlink, set, &ack);
+		ret = op->write_enum(devlink, set
+#ifdef HAVE_DEVLINK_ESWITCH_MODE_SET_EXTACK
+				   , &ack
+#endif
+				   );
 
+#ifdef HAVE_NETLINK_EXT_ACK
 	if (ack._msg)
 		mlx5_core_warn(dev, "%s\n", ack._msg);
-
+#endif
 	if (ret < 0)
 		return ret;
 
