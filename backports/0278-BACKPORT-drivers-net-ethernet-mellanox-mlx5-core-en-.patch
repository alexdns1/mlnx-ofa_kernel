From: Chris Mi <cmi@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/en/tc/sample.c

Change-Id: Id9167d5c119f6591b0379c4885197a40238f570b
---
 .../net/ethernet/mellanox/mlx5/core/en/tc/sample.c | 14 ++++++++++++++
 1 file changed, 14 insertions(+)

--- a/drivers/net/ethernet/mellanox/mlx5/core/en/tc/sample.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en/tc/sample.c
@@ -348,6 +348,7 @@ sample_restore_put(struct mlx5e_tc_psamp
 
 void mlx5e_tc_sample_skb(struct sk_buff *skb, struct mlx5_mapped_obj *mapped_obj)
 {
+#if defined(HAVE_STRUCT_PSAMPLE_METADATA)
 	u32 trunc_size = mapped_obj->sample.trunc_size;
 	struct psample_group psample_group = {};
 	struct psample_metadata md = {};
@@ -359,6 +360,19 @@ void mlx5e_tc_sample_skb(struct sk_buff
 	skb_push(skb, skb->mac_len);
 
 	psample_sample_packet(&psample_group, skb, mapped_obj->sample.rate, &md);
+#else
+	u32 trunc_size = mapped_obj->sample.trunc_size;
+	struct psample_group psample_group = {};
+	int iif = skb->dev->ifindex;
+	u32 size;
+
+	size = trunc_size ? min(trunc_size, skb->len) : skb->len;
+	psample_group.group_num = mapped_obj->sample.group_id;
+	psample_group.net = &init_net;
+	skb_push(skb, skb->mac_len);
+
+	psample_sample_packet(&psample_group, skb, size, iif, 0, mapped_obj->sample.rate);
+#endif
 }
 
 static int
