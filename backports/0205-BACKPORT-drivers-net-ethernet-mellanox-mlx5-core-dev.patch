From: Maher Sanalla <msanalla@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/net/ethernet/mellanox/mlx5/core/dev.c

Change-Id: I95b623530001db1de1bb245437eb83d888f10b49
---
 drivers/net/ethernet/mellanox/mlx5/core/dev.c | 22 ++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/dev.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/dev.c
@@ -221,12 +221,20 @@ static const struct mlx5_adev_device {
 
 int mlx5_adev_idx_alloc(void)
 {
+#ifdef HAVE_IDA_ALLOC
 	return ida_alloc(&mlx5_adev_ida, GFP_KERNEL);
+#else
+	return ida_simple_get(&mlx5_adev_ida,0, 0, GFP_KERNEL);
+#endif
 }
 
 void mlx5_adev_idx_free(int idx)
 {
+#ifdef HAVE_IDA_FREE
 	ida_free(&mlx5_adev_ida, idx);
+#else
+	ida_simple_remove(&mlx5_adev_ida, idx);
+#endif
 }
 
 int mlx5_adev_init(struct mlx5_core_dev *dev)
@@ -512,7 +520,11 @@ static int _next_phys_dev(struct mlx5_co
 	return 1;
 }
 
+#if defined(HAVE_LINUX_DEVICE_BUS_H) || defined(HAVE_BUS_FIND_DEVICE_GET_CONST)
 static int next_phys_dev(struct device *dev, const void *data)
+#else
+static int next_phys_dev(struct device *dev, void *data)
+#endif /* HAVE_BUS_FIND_DEVICE_GET_CONST || HAVE_LINUX_DEVICE_BUS_H */
 {
 	struct mlx5_core_dev *mdev;
 	struct mlx5_adev *madev;
@@ -532,7 +544,11 @@ static int next_phys_dev(struct device *
 	return _next_phys_dev(mdev, data);
 }
 
+#if defined(HAVE_LINUX_DEVICE_BUS_H) || defined(HAVE_BUS_FIND_DEVICE_GET_CONST)
 static int next_phys_dev_lag(struct device *dev, const void *data)
+#else
+static int next_phys_dev_lag(struct device *dev, void *data)
+#endif /* HAVE_BUS_FIND_DEVICE_GET_CONST || HAVE_LINUX_DEVICE_BUS_H */
 {
 	struct mlx5_core_dev *mdev;
 	struct mlx5_adev *madev;
@@ -557,9 +573,13 @@ static int next_phys_dev_lag(struct devi
 
 	return _next_phys_dev(mdev, data);
 }
-
+#if defined(HAVE_LINUX_DEVICE_BUS_H) || defined(HAVE_BUS_FIND_DEVICE_GET_CONST)
 struct mlx5_core_dev *mlx5_get_next_dev(struct mlx5_core_dev *dev,
 					int (*match)(struct device *dev, const void *data))
+#else
+struct mlx5_core_dev *mlx5_get_next_dev(struct mlx5_core_dev *dev,
+					int (*match)(struct device *dev, void *data))
+#endif /* HAVE_BUS_FIND_DEVICE_GET_CONST || HAVE_LINUX_DEVICE_BUS_H */
 {
 	struct auxiliary_device *adev;
 	struct mlx5_adev *madev;
