From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/net/ethernet/mellanox/mlx5/core/dev.c

Change-Id: I86a53ab04705904c9af522a639e3fea6398480eb
---
 drivers/net/ethernet/mellanox/mlx5/core/dev.c | 12 ++++++++++++
 1 file changed, 12 insertions(+)

--- a/drivers/net/ethernet/mellanox/mlx5/core/dev.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/dev.c
@@ -221,12 +221,20 @@ static const struct mlx5_adev_device {
 
 int mlx5_adev_idx_alloc(void)
 {
+#ifdef HAVE_IDA_ALLOC
 	return ida_alloc(&mlx5_adev_ida, GFP_KERNEL);
+#else
+	return ida_simple_get(&mlx5_adev_ida,0, 0, GFP_KERNEL);
+#endif
 }
 
 void mlx5_adev_idx_free(int idx)
 {
+#ifdef HAVE_IDA_FREE
 	ida_free(&mlx5_adev_ida, idx);
+#else
+	ida_simple_remove(&mlx5_adev_ida, idx);
+#endif
 }
 
 int mlx5_adev_init(struct mlx5_core_dev *dev)
@@ -496,7 +504,11 @@ static u32 mlx5_gen_pci_id(const struct
 		     PCI_SLOT(dev->pdev->devfn));
 }
 
+#ifdef HAVE_BUS_FIND_DEVICE_GET_CONST
 static int next_phys_dev(struct device *dev, const void *data)
+#else
+static int next_phys_dev(struct device *dev, void *data)
+#endif
 {
 	struct mlx5_adev *madev = container_of(dev, struct mlx5_adev, adev.dev);
 	struct mlx5_core_dev *mdev = madev->mdev;
