From: Tom Wu <tomwu@mellanox.com>
Subject: [PATCH] BACKPORT: include/linux/sunrpc/svc_rdma.h

Change-Id: Ie9901a8f44aefd1120c269c1034c10ba251488df
---
 include/linux/sunrpc/svc_rdma.h | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

--- a/include/linux/sunrpc/svc_rdma.h
+++ b/include/linux/sunrpc/svc_rdma.h
@@ -42,7 +42,9 @@
 
 #ifndef SVC_RDMA_H
 #define SVC_RDMA_H
+#ifdef HAVE_SVC_FILL_WRITE_VECTOR
 #include <linux/llist.h>
+#endif
 #include <linux/sunrpc/xdr.h>
 #include <linux/sunrpc/svcsock.h>
 #include <linux/sunrpc/rpc_rdma.h>
@@ -108,7 +110,12 @@ struct svcxprt_rdma {
 	struct list_head     sc_read_complete_q;
 	struct work_struct   sc_work;
 
+#ifdef HAVE_SVC_FILL_WRITE_VECTOR
 	struct llist_head    sc_recv_ctxts;
+#else
+	spinlock_t	     sc_recv_lock;
+	struct list_head     sc_recv_ctxts;
+#endif
 };
 /* sc_flags */
 #define RDMAXPRT_CONN_PENDING	3
@@ -125,17 +132,27 @@ enum {
 #define RPCSVC_MAXPAYLOAD_RDMA	RPCSVC_MAXPAYLOAD
 
 struct svc_rdma_recv_ctxt {
+#ifdef HAVE_SVC_FILL_WRITE_VECTOR
 	struct llist_node	rc_node;
+#endif
 	struct list_head	rc_list;
 	struct ib_recv_wr	rc_recv_wr;
 	struct ib_cqe		rc_cqe;
+#ifdef HAVE_SVC_FILL_WRITE_VECTOR
 	struct ib_sge		rc_recv_sge;
 	void			*rc_recv_buf;
+#endif
 	struct xdr_buf		rc_arg;
+#ifdef HAVE_SVC_FILL_WRITE_VECTOR
 	bool			rc_temp;
+#endif
 	u32			rc_byte_len;
 	unsigned int		rc_page_count;
 	unsigned int		rc_hdr_count;
+#ifndef HAVE_SVC_FILL_WRITE_VECTOR
+	struct ib_sge		rc_sges[1 +
+					RPCRDMA_MAX_INLINE_THRESH / PAGE_SIZE];
+#endif
 	u32			rc_inv_rkey;
 	struct page		*rc_pages[RPCSVC_MAXPAGES];
 };
