From: Karam Ghanayem <kghanayem@nvidia.com>
Subject: [PATCH] BACKPORT: drivers/nvme/target/passthru.c

Change-Id: I0baf34ae65c0dbdcb87b42af2f6bbcf549ade2b9
Signed-off-by: Karam Ghanayem <kghanayem@nvidia.com>
---
 drivers/nvme/target/passthru.c | 22 +++++++++++++++++++++-
 1 file changed, 21 insertions(+), 1 deletion(-)

--- a/drivers/nvme/target/passthru.c
+++ b/drivers/nvme/target/passthru.c
@@ -187,14 +187,21 @@ static int nvmet_passthru_map_sg(struct
 	struct scatterlist *sg;
 	int op_flags = 0;
 	struct bio *bio;
-	int i, ret;
+ 	int i;
+#ifndef HAVE_BLK_RQ_BIO_PREP
+	int ret;
+#endif
 
 	if (req->cmd->common.opcode == nvme_cmd_flush)
 		op_flags = REQ_FUA;
 	else if (nvme_is_write(req->cmd))
 		op_flags = REQ_SYNC | REQ_IDLE;
 
+#ifdef HAVE_BIO_MAX_SEGS
+	bio = bio_alloc(GFP_KERNEL, bio_max_segs(req->sg_cnt));
+#else
 	bio = bio_alloc(GFP_KERNEL, min(sg_cnt, BIO_MAX_PAGES));
+#endif
 	bio->bi_end_io = bio_put;
 	bio->bi_opf = req_op(rq) | op_flags;
 
@@ -207,11 +214,15 @@ static int nvmet_passthru_map_sg(struct
 		sg_cnt--;
 	}
 
+#ifdef HAVE_BLK_RQ_BIO_PREP
+ 	blk_rq_bio_prep(rq, bio, req->sg_cnt);
+#else
 	ret = blk_rq_append_bio(rq, &bio);
 	if (unlikely(ret)) {
 		bio_put(bio);
 		return ret;
 	}
+#endif
 
 	return 0;
 }
@@ -267,8 +278,17 @@ static void nvmet_passthru_execute_cmd(s
 		schedule_work(&req->p.work);
 	} else {
 		rq->end_io_data = req;
+#ifdef HAVE_BLK_EXECUTE_RQ_NOWAIT_5_PARAM
 		blk_execute_rq_nowait(rq->q, ns ? ns->disk : NULL, rq, 0,
 				      nvmet_passthru_req_done);
+#else
+#ifdef HAVE_BLK_EXECUTE_RQ_2_PARAM
+		blk_execute_rq_nowait(rq, false, nvmet_passthru_req_done);
+#else
+		blk_execute_rq_nowait(ns ? ns->disk : NULL, rq, 0,
+				      nvmet_passthru_req_done);
+#endif
+#endif
 	}
 
 	if (ns)
