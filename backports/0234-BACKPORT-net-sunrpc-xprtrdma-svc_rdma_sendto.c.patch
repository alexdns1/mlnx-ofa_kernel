From: Tom Wu <tomwu@mellanox.com>
Subject: [PATCH] BACKPORT: net/sunrpc/xprtrdma/svc_rdma_sendto.c

Change-Id: I281cedaa5e5b03ac033b95282f1f8e82e3f973d8
---
 net/sunrpc/xprtrdma/svc_rdma_sendto.c | 18 ++++++++++++++++++
 1 file changed, 18 insertions(+)

--- a/net/sunrpc/xprtrdma/svc_rdma_sendto.c
+++ b/net/sunrpc/xprtrdma/svc_rdma_sendto.c
@@ -110,7 +110,9 @@
 #include <linux/sunrpc/svc_rdma.h>
 
 #include "xprt_rdma.h"
+#ifdef HAVE_TRACE_RPCRDMA_H
 #include <trace/events/rpcrdma.h>
+#endif
 
 #define RPCDBG_FACILITY	RPCDBG_SVCXPRT
 
@@ -238,9 +240,11 @@ void svc_rdma_send_ctxt_put(struct svcxp
 				  ctxt->sc_sges[i].addr,
 				  ctxt->sc_sges[i].length,
 				  DMA_TO_DEVICE);
+#ifdef HAVE_TRACE_RPCRDMA_H
 		trace_svcrdma_dma_unmap_page(rdma,
 					     ctxt->sc_sges[i].addr,
 					     ctxt->sc_sges[i].length);
+#endif
 	}
 
 	for (i = 0; i < ctxt->sc_page_count; ++i)
@@ -265,7 +269,9 @@ static void svc_rdma_wc_send(struct ib_c
 	struct ib_cqe *cqe = wc->wr_cqe;
 	struct svc_rdma_send_ctxt *ctxt;
 
+#ifdef HAVE_TRACE_RPCRDMA_H
 	trace_svcrdma_wc_send(wc);
+#endif
 
 	atomic_inc(&rdma->sc_sq_avail);
 	wake_up(&rdma->sc_send_wait);
@@ -299,19 +305,25 @@ int svc_rdma_send(struct svcxprt_rdma *r
 	while (1) {
 		if ((atomic_dec_return(&rdma->sc_sq_avail) < 0)) {
 			atomic_inc(&rdma_stat_sq_starve);
+#ifdef HAVE_TRACE_RPCRDMA_H
 			trace_svcrdma_sq_full(rdma);
+#endif
 			atomic_inc(&rdma->sc_sq_avail);
 			wait_event(rdma->sc_send_wait,
 				   atomic_read(&rdma->sc_sq_avail) > 1);
 			if (test_bit(XPT_CLOSE, &rdma->sc_xprt.xpt_flags))
 				return -ENOTCONN;
+#ifdef HAVE_TRACE_RPCRDMA_H
 			trace_svcrdma_sq_retry(rdma);
+#endif
 			continue;
 		}
 
 		svc_xprt_get(&rdma->sc_xprt);
 		ret = ib_post_send(rdma->sc_qp, wr, NULL);
+#ifdef HAVE_TRACE_RPCRDMA_H
 		trace_svcrdma_post_send(wr, ret);
+#endif
 		if (ret) {
 			set_bit(XPT_CLOSE, &rdma->sc_xprt.xpt_flags);
 			svc_xprt_put(&rdma->sc_xprt);
@@ -494,7 +506,9 @@ static int svc_rdma_dma_map_page(struct
 	dma_addr_t dma_addr;
 
 	dma_addr = ib_dma_map_page(dev, page, offset, len, DMA_TO_DEVICE);
+#ifdef HAVE_TRACE_RPCRDMA_H
 	trace_svcrdma_dma_map_page(rdma, dma_addr, len);
+#endif
 	if (ib_dma_mapping_error(dev, dma_addr))
 		goto out_maperr;
 
@@ -789,7 +803,9 @@ static int svc_rdma_send_error_msg(struc
 	int ret;
 
 	p = ctxt->sc_xprt_buf;
+#ifdef HAVE_TRACE_RPCRDMA_H
 	trace_svcrdma_err_chunk(*p);
+#endif
 	p += 3;
 	*p++ = rdma_error;
 	*p   = err_chunk;
@@ -895,7 +911,9 @@ out:
  err1:
 	svc_rdma_send_ctxt_put(rdma, sctxt);
  err0:
+#ifdef HAVE_TRACE_RPCRDMA_H
 	trace_svcrdma_send_failed(rqstp, ret);
+#endif
 	set_bit(XPT_CLOSE, &xprt->xpt_flags);
 	ret = -ENOTCONN;
 	goto out;
