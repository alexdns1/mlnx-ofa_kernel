From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/sriov_sysfs.c

Change-Id: Ic23f3a0e9d1e172026f35ccbdc297ce192d4b0be
---
 .../ethernet/mellanox/mlx5/core/sriov_sysfs.c   | 17 +++++++++++++++--
 1 file changed, 15 insertions(+), 2 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/sriov_sysfs.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/sriov_sysfs.c
@@ -105,6 +105,7 @@ static ssize_t vf_paging_attr_store(stru
 	return ga->store(g, ga, buf, size);
 }
 
+#ifdef CONFIG_MLX5_ESWITCH
 struct vf_group_attributes {
 	struct attribute attr;
 	ssize_t (*show)(struct mlx5_vgroup *, struct vf_group_attributes *,
@@ -191,7 +192,7 @@ static ssize_t min_tx_rate_group_store(s
 
 	return err ? err : count;
 }
-
+#endif
 static ssize_t port_show(struct mlx5_sriov_vf *g, struct vf_attributes *oa,
 			 char *buf)
 {
@@ -1096,15 +1097,25 @@ static ssize_t num_vf_show(struct device
 
 static DEVICE_ATTR(mlx5_num_vfs, 0600, num_vf_show, num_vf_store);
 
+#ifdef CONFIG_COMPAT_IS_CONST_KOBJECT_SYSFS_OPS
 static const struct sysfs_ops vf_sysfs_ops = {
+#else
+static struct sysfs_ops vf_sysfs_ops = {
+#endif
 	.show = vf_attr_show,
 	.store = vf_attr_store,
 };
 
+#ifdef CONFIG_MLX5_ESWITCH
+#ifdef CONFIG_COMPAT_IS_CONST_KOBJECT_SYSFS_OPS
 static const struct sysfs_ops vf_group_sysfs_ops = {
+#else
+static struct sysfs_ops vf_group_sysfs_ops = {
+#endif
 	.show = vf_group_attr_show,
 	.store = vf_group_attr_store,
 };
+#endif
 
 static const struct sysfs_ops vf_paging_ops = {
 	.show = vf_paging_attr_show,
@@ -1266,7 +1277,9 @@ err_attr:
 		sriov->groups_config = NULL;
 	}
 
+#ifdef CONFIG_MLX5_ESWITCH
 err_groups:
+#endif
 	kobject_put(sriov->config);
 	sriov->config = NULL;
 	return err;
@@ -1290,10 +1303,10 @@ void mlx5_sriov_sysfs_cleanup(struct mlx
 int mlx5_create_vf_group_sysfs(struct mlx5_core_dev *dev,
 			       u32 group_id, struct kobject *group_kobj)
 {
+#ifdef CONFIG_MLX5_ESWITCH
 	struct mlx5_core_sriov *sriov = &dev->priv.sriov;
 	int err;
 
-#ifdef CONFIG_MLX5_ESWITCH
 	err = kobject_init_and_add(group_kobj, &vf_group, sriov->groups_config,
 				   "%d", group_id);
 	if (err)
