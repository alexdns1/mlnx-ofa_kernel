From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/steering/dr_dbg.c

Change-Id: I3d8ffecac35a28bdaa09cd3c9b92f8c0029f7398
---
 .../mellanox/mlx5/core/steering/dr_dbg.c        | 17 +++++++++++++++++
 1 file changed, 17 insertions(+)

--- a/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_dbg.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/steering/dr_dbg.c
@@ -933,7 +933,11 @@ static void dr_dump_free_buffers_list(st
 
 static int dr_dump_proc_open(struct inode *inode, struct file *file)
 {
+#ifdef HAVE_PDE_DATA
+	struct mlx5dr_domain *dmn = pde_data(inode);
+#else
 	struct mlx5dr_domain *dmn = PDE_DATA(inode);
+#endif
 	struct dr_dump_ctx *ctx;
 	struct dr_buffer *buf;
 	int ret;
@@ -983,11 +987,20 @@ static int dr_dump_proc_release(struct i
 	return 0;
 }
 
+#ifdef HAVE_PROC_OPS_STRUCT
 static const struct proc_ops mlx5_crdump_ops = {
 	.proc_read = dr_dump_proc_read,
 	.proc_open = dr_dump_proc_open,
 	.proc_release = dr_dump_proc_release
 };
+#else
+static const struct file_operations mlx5_crdump_fops = {
+	.owner = THIS_MODULE,
+	.read = dr_dump_proc_read,
+	.open = dr_dump_proc_open,
+	.release = dr_dump_proc_release
+};
+#endif
 
 int mlx5dr_dbg_init_dump(struct mlx5dr_domain *dmn)
 {
@@ -1001,7 +1014,11 @@ int mlx5dr_dbg_init_dump(struct mlx5dr_d
 	if (mlx5_smfs_fdb_dump_dir) {
 		proc_entry = proc_create_data(pci_name(dmn->mdev->pdev), 0444,
 					      mlx5_smfs_fdb_dump_dir,
+#ifdef HAVE_PROC_OPS_STRUCT
 					      &mlx5_crdump_ops, dmn);
+#else
+					      &mlx5_crdump_fops, dmn);
+#endif
 		if (!proc_entry)
 			mlx5_core_warn(dmn->mdev, "failed to create dump proc file\n");
 	}
