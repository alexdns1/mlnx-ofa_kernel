From: Valentine Fatiev <valentinef@nvidia.com>
Subject: [PATCH] BACKPORT:
 drivers/net/ethernet/mellanox/mlx5/core/en/xsk/setup.c

Change-Id: I97d2aab5ea38d279f4b1fd7dbfbf56b3ed5558a2
---
 .../mellanox/mlx5/core/en/xsk/setup.c         | 29 +++++++++++++++++--
 1 file changed, 26 insertions(+), 3 deletions(-)

--- a/drivers/net/ethernet/mellanox/mlx5/core/en/xsk/setup.c
+++ b/drivers/net/ethernet/mellanox/mlx5/core/en/xsk/setup.c
@@ -1,6 +1,7 @@
 // SPDX-License-Identifier: GPL-2.0 OR Linux-OpenIB
 /* Copyright (c) 2019 Mellanox Technologies. */
 
+#ifdef HAVE_XSK_ZERO_COPY_SUPPORT
 #include "setup.h"
 #include "en/params.h"
 #include "en/txrx.h"
@@ -47,7 +48,11 @@ static void mlx5e_build_xsk_cparam(struc
 
 static int mlx5e_init_xsk_rq(struct mlx5e_channel *c,
 			     struct mlx5e_params *params,
+#ifdef HAVE_NETDEV_BPF_XSK_BUFF_POOL
 			     struct xsk_buff_pool *pool,
+#else
+			     struct xdp_umem *umem,
+#endif
 			     struct mlx5e_xsk_param *xsk,
 			     struct mlx5e_rq *rq)
 {
@@ -66,19 +71,31 @@ static int mlx5e_init_xsk_rq(struct mlx5
 	rq->mdev         = mdev;
 	rq->hw_mtu       = MLX5E_SW2HW_MTU(params, params->sw_mtu);
 	rq->xdpsq        = &c->rq_xdpsq;
+#ifdef HAVE_NETDEV_BPF_XSK_BUFF_POOL
 	rq->xsk_pool     = pool;
+#else
+	rq->umem     	 = umem;
+#endif
 	rq->stats        = &c->priv->channel_stats[c->ix].xskrq;
 	rq->ptp_cyc2time = mlx5_rq_ts_translator(mdev);
 	rq_xdp_ix        = c->ix + params->num_channels * MLX5E_RQ_GROUP_XSK;
 	err = mlx5e_rq_set_handlers(rq, params, xsk);
 	if (err)
 		return err;
-
+#ifdef HAVE_XDP_RXQ_INFO_REG_4_PARAMS
 	return  xdp_rxq_info_reg(&rq->xdp_rxq, rq->netdev, rq_xdp_ix, 0);
+#else
+	return  xdp_rxq_info_reg(&rq->xdp_rxq, rq->netdev, rq_xdp_ix);
+#endif
 }
 
 static int mlx5e_open_xsk_rq(struct mlx5e_channel *c, struct mlx5e_params *params,
-			     struct mlx5e_rq_param *rq_params, struct xsk_buff_pool *pool,
+			     struct mlx5e_rq_param *rq_params,
+#ifdef HAVE_NETDEV_BPF_XSK_BUFF_POOL
+			     struct xsk_buff_pool *pool,
+#else
+			     struct xdp_umem *pool,
+#endif
 			     struct mlx5e_create_cq_param *ccp, struct mlx5e_xsk_param *xsk)
 {
 	int err;
@@ -91,7 +108,12 @@ static int mlx5e_open_xsk_rq(struct mlx5
 }
 
 int mlx5e_open_xsk(struct mlx5e_priv *priv, struct mlx5e_params *params,
-		   struct mlx5e_xsk_param *xsk, struct xsk_buff_pool *pool,
+		   struct mlx5e_xsk_param *xsk,
+#ifdef HAVE_NETDEV_BPF_XSK_BUFF_POOL
+		   struct xsk_buff_pool *pool,
+#else
+		   struct xdp_umem *pool,
+#endif
 		   struct mlx5e_channel *c)
 {
 	struct mlx5e_channel_param *cparam;
@@ -243,3 +265,4 @@ void mlx5e_xsk_redirect_rqts_to_drop(str
 		mlx5e_xsk_redirect_rqt_to_drop(priv, i);
 	}
 }
+#endif /* HAVE_XSK_ZERO_COPY_SUPPORT */
